<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>管理员后台 - 立信英语</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="admin.html">
                <i class="bi bi-shield-lock"></i> 管理员后台
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">返回前台</a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <span id="admin-info" class="navbar-text me-3"></span>
                    <button id="logout-btn" class="btn btn-outline-light btn-sm">登出</button>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容 -->
    <div class="container-fluid mt-5 pt-4">
        <div class="row">
            <!-- 侧边栏 -->
            <div class="col-lg-2 d-none d-lg-block bg-light sidebar">
                <div class="position-sticky pt-3">
                    <ul class="nav flex-column">
                        <li class="nav-item">
                            <a class="nav-link active" href="#" data-tab="dashboard">
                                <i class="bi bi-speedometer2"></i> 仪表板
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="users">
                                <i class="bi bi-people"></i> 用户管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="learning">
                                <i class="bi bi-book"></i> 学习记录
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="vocabulary">
                                <i class="bi bi-collection"></i> 生词管理
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="statistics">
                                <i class="bi bi-bar-chart"></i> 数据统计
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" data-tab="settings">
                                <i class="bi bi-gear"></i> 系统设置
                            </a>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- 移动端侧边栏按钮 -->
            <div class="col-12 d-lg-none mb-3">
                <button class="btn btn-primary w-100" type="button" data-bs-toggle="offcanvas" data-bs-target="#mobileSidebar">
                    <i class="bi bi-list"></i> 菜单
                </button>
                
                <div class="offcanvas offcanvas-start" tabindex="-1" id="mobileSidebar">
                    <div class="offcanvas-header">
                        <h5 class="offcanvas-title">管理菜单</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
                    </div>
                    <div class="offcanvas-body">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="#" data-tab="dashboard">仪表板</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-tab="users">用户管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-tab="learning">学习记录</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-tab="vocabulary">生词管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-tab="statistics">数据统计</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#" data-tab="settings">系统设置</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- 主要内容区域 -->
            <div class="col-lg-10">
                <!-- 仪表板 -->
                <div id="dashboard-tab" class="admin-tab">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">仪表板</h1>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3 mb-4">
                            <div class="card text-white bg-primary">
                                <div class="card-body">
                                    <h5 class="card-title">总用户数</h5>
                                    <h2 id="total-users">0</h2>
                                    <p class="card-text">活跃用户: <span id="active-users">0</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card text-white bg-success">
                                <div class="card-body">
                                    <h5 class="card-title">学习记录</h5>
                                    <h2 id="total-records">0</h2>
                                    <p class="card-text">今日新增: <span id="today-records">0</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card text-white bg-warning">
                                <div class="card-body">
                                    <h5 class="card-title">生词数量</h5>
                                    <h2 id="total-words">0</h2>
                                    <p class="card-text">本周新增: <span id="week-words">0</span></p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 mb-4">
                            <div class="card text-white bg-info">
                                <div class="card-body">
                                    <h5 class="card-title">在线用户</h5>
                                    <h2 id="online-users">0</h2>
                                    <p class="card-text">最近24小时: <span id="recent-users">0</span></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-8">
                            <div class="card">
                                <div class="card-header">
                                    <h5>最近注册用户</h5>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th>姓名</th>
                                                    <th>邮箱</th>
                                                    <th>注册时间</th>
                                                    <th>最后登录</th>
                                                </tr>
                                            </thead>
                                            <tbody id="recent-users-table">
                                                <tr>
                                                    <td colspan="4" class="text-center">加载中...</td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-header">
                                    <h5>系统状态</h5>
                                </div>
                                <div class="card-body">
                                    <ul class="list-group list-group-flush">
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            数据库连接
                                            <span class="badge bg-success rounded-pill">正常</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            API服务
                                            <span class="badge bg-success rounded-pill">正常</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            存储空间
                                            <span class="badge bg-warning rounded-pill">85%</span>
                                        </li>
                                        <li class="list-group-item d-flex justify-content-between align-items-center">
                                            备份状态
                                            <span class="badge bg-success rounded-pill">最新</span>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 用户管理 -->
                <div id="users-tab" class="admin-tab d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">用户管理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-sm btn-outline-secondary me-2" onclick="refreshUsers()">
                                <i class="bi bi-arrow-repeat"></i> 刷新
                            </button>
                            <button class="btn btn-sm btn-primary" onclick="showAddUserModal()">
                                <i class="bi bi-plus"></i> 添加用户
                            </button>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="user-search" placeholder="搜索用户...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="user-status-filter">
                                <option value="">全部状态</option>
                                <option value="active">活跃</option>
                                <option value="inactive">非活跃</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="user-sort">
                                <option value="createdAt">注册时间</option>
                                <option value="lastLogin">最后登录</option>
                                <option value="name">姓名</option>
                            </select>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>姓名</th>
                                            <th>邮箱</th>
                                            <th>注册时间</th>
                                            <th>最后登录</th>
                                            <th>状态</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="users-table-body">
                                        <tr>
                                            <td colspan="6" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            
                            <nav aria-label="用户列表分页">
                                <ul class="pagination justify-content-center" id="users-pagination">
                                    <!-- 分页内容将动态生成 -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>

                <!-- 学习记录管理 -->
                <div id="learning-tab" class="admin-tab d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">学习记录管理</h1>
                        <div class="btn-toolbar mb-2 mb-md-0">
                            <button class="btn btn-sm btn-outline-secondary" onclick="refreshLearningRecords()">
                                <i class="bi bi-arrow-repeat"></i> 刷新
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>用户</th>
                                            <th>学习内容</th>
                                            <th>时长(分钟)</th>
                                            <th>得分</th>
                                            <th>时间</th>
                                            <th>操作</th>
                                        </tr>
                                    </thead>
                                    <tbody id="learning-records-table">
                                        <tr>
                                            <td colspan="6" class="text-center">加载中...</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 其他标签页内容... -->
                <div id="vocabulary-tab" class="admin-tab d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">生词管理</h1>
                    </div>
                    <div class="alert alert-info">生词管理功能正在开发中...</div>
                </div>

                <div id="statistics-tab" class="admin-tab d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">数据统计</h1>
                    </div>
                    <div class="alert alert-info">数据统计功能正在开发中...</div>
                </div>

                <div id="settings-tab" class="admin-tab d-none">
                    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
                        <h1 class="h2">系统设置</h1>
                    </div>
                    <div class="alert alert-info">系统设置功能正在开发中...</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 添加用户模态框 -->
    <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">添加用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="add-user-form">
                        <div class="mb-3">
                            <label for="user-name" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="user-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="user-email" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="user-email" required>
                        </div>
                        <div class="mb-3">
                            <label for="user-password" class="form-label">密码</label>
                            <input type="password" class="form-control" id="user-password" required minlength="6">
                        </div>
                        <div class="mb-3">
                            <label for="user-phone" class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="user-phone">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="addUser()">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 编辑用户模态框 -->
    <div class="modal fade" id="editUserModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑用户</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-user-form">
                        <input type="hidden" id="edit-user-id">
                        <div class="mb-3">
                            <label for="edit-user-name" class="form-label">姓名</label>
                            <input type="text" class="form-control" id="edit-user-name" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit-user-email" class="form-label">邮箱</label>
                            <input type="email" class="form-control" id="edit-user-email" required readonly>
                        </div>
                        <div class="mb-3">
                            <label for="edit-user-phone" class="form-label">手机号</label>
                            <input type="tel" class="form-control" id="edit-user-phone">
                        </div>
                        <div class="mb-3">
                            <label for="edit-user-bio" class="form-label">个人简介</label>
                            <textarea class="form-control" id="edit-user-bio" rows="3"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="updateUser()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white py-3 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">© 2024 立信英语. 管理员后台</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">版本 1.0.0</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="api.js"></script>
    <script>
        // 管理员管理逻辑
        let currentUser = null;
        let currentUsersPage = 1;
        const usersPerPage = 10;

        // 检查管理员权限
        async function checkAdminAccess() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = 'login.html';
                return false;
            }

            try {
                const result = await api.getCurrentUser();
                currentUser = result.user;
                
                // 检查是否为管理员
                const adminEmails = ['admin@example.com', 'admin@liuxinenglish.com'];
                if (!adminEmails.includes(currentUser.email)) {
                    alert('您没有管理员权限');
                    window.location.href = 'index.html';
                    return false;
                }
                
                // 显示管理员信息
                document.getElementById('admin-info').textContent = `管理员: ${currentUser.name}`;
                return true;
            } catch (error) {
                console.error('验证管理员权限失败:', error);
                api.logout();
                window.location.href = 'login.html';
                return false;
            }
        }

        // 标签页切换
        function setupTabNavigation() {
            document.querySelectorAll('[data-tab]').forEach(tab => {
                tab.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // 更新激活状态
                    document.querySelectorAll('[data-tab]').forEach(t => {
                        t.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // 显示对应内容
                    const tabName = this.getAttribute('data-tab');
                    document.querySelectorAll('.admin-tab').forEach(content => {
                        content.classList.add('d-none');
                    });
                    document.getElementById(`${tabName}-tab`).classList.remove('d-none');
                    
                    // 根据标签页加载对应数据
                    switch(tabName) {
                        case 'dashboard':
                            loadDashboardData();
                            break;
                        case 'users':
                            loadUsers(1);
                            break;
                        case 'learning':
                            loadLearningRecords();
                            break;
                    }
                });
            });
        }

        // 加载仪表板数据
        //async function loadDashboardData() {
        //    try {
        //        // 这里应该调用后端API获取统计数据
        //        // 暂时使用模拟数据
        //        document.getElementById('total-users').textContent = '156';
        //        document.getElementById('active-users').textContent = '123';
        //        document.getElementById('total-records').textContent = '2,345';
        //        document.getElementById('today-records').textContent = '45';
        //        document.getElementById('total-words').textContent = '1,234';
        //        document.getElementById('week-words').textContent = '89';
        //        document.getElementById('online-users').textContent = '23';
        //        document.getElementById('recent-users').textContent = '34';
        //        
        //        // 加载最近用户
        //        loadRecentUsers();
        //    } catch (error) {
        //        console.error('加载仪表板数据失败:', error);
        //    }
        //}

		// 加载仪表板数据
		//async function loadDashboardData() {
		//	try {
		//		console.log('[admin.html] 开始加载仪表板数据...');
		//		// 显示加载状态
		//		document.getElementById('total-users').textContent = '加载中...';
		//		document.getElementById('active-users').textContent = '...';
		//		document.getElementById('total-records').textContent = '加载中...';
		//		document.getElementById('today-records').textContent = '...';
		//		document.getElementById('total-words').textContent = '加载中...';
		//		document.getElementById('week-words').textContent = '...';
		//		document.getElementById('online-users').textContent = '加载中...';
		//		document.getElementById('recent-users').textContent = '...';
		//		// 如果有最近注册用户表格，也显示加载状态
		//		document.getElementById('recent-users-table').innerHTML = '<tr><td colspan="4" class="text-center">加载中...</td></tr>';
		//
		//		// 调用新的后端 API
		//		const response = await fetch('/api/admin/dashboard/stats', {
		//			method: 'GET',
		//			headers: {
		//				'Authorization': `Bearer ${localStorage.getItem('token')}`, // 确保携带认证 Token
		//				'Content-Type': 'application/json'
		//			}
		//		});
		//
		//		if (!response.ok) {
		//			throw new Error(`HTTP error! status: ${response.status}`);
		//		}
		//
		//		const data = await response.json();
		//		console.log('[admin.html] 收到仪表板数据:', data);
		//
		//		if (data.success) {
		//			const stats = data.stats;
		//			console.log('[admin.html] 收到仪表板数据:', stats);
		//
		//			// 更新 UI - 用户统计
		//			document.getElementById('total-users').textContent = stats.users.total;
		//			document.getElementById('active-users').textContent = stats.users.active;
		//			document.getElementById('online-users').textContent = stats.users.online; // 使用估算的在线用户数
		//			document.getElementById('recent-users').textContent = stats.users.recent24h; // 使用最近 24 小时活跃用户数
		//
		//			// 更新 UI - 学习记录统计
		//			document.getElementById('total-records').textContent = stats.learning.totalRecords;
		//			document.getElementById('today-records').textContent = stats.learning.newToday;
		//
		//			// 更新 UI - 生词统计
		//			document.getElementById('total-words').textContent = stats.vocabulary.totalCore;
		//			document.getElementById('week-words').textContent = stats.vocabulary.newThisWeek;
		//
		//			// --- 可选：更新最近注册用户表格 ---
		//			// 这需要一个单独的 API 端点来获取最近注册的用户列表
		//			// 例如：GET /api/admin/users?sort=createdAt&order=desc&limit=5
		//			// loadRecentUsers(); // 调用另一个函数来加载最近用户
		//
		//		} else {
		//			throw new Error(data.error || '获取仪表板数据失败');
		//		}
		//
		//	} catch (error) {
		//		console.error('[admin.html] 加载仪表板数据失败:', error);
		//		// 显示错误信息
		//		document.getElementById('total-users').textContent = '错误';
		//		document.getElementById('active-users').textContent = '...';
		//		document.getElementById('total-records').textContent = '错误';
		//		document.getElementById('today-records').textContent = '...';
		//		document.getElementById('total-words').textContent = '错误';
		//		document.getElementById('week-words').textContent = '...';
		//		document.getElementById('online-users').textContent = '错误';
		//		document.getElementById('recent-users').textContent = '...';
		//		alert('加载仪表板数据失败: ' + error.message);
		//	}
		//}

		//async function loadDashboardData() {
		//	console.log('[admin.html] 开始加载仪表板数据...');
		//	const token = localStorage.getItem('token');
		//	if (!token) {
		//		console.error('[admin.html] 未找到 Token，无法加载仪表板数据');
		//		// 可以选择跳转到登录页或显示错误
		//		// window.location.href = 'login.html';
		//		return;
		//	}
		//
		//	try {
		//		// 1. 显示加载状态
		//		document.getElementById('total-users').textContent = '...';
		//		document.getElementById('active-users').textContent = '...';
		//		document.getElementById('total-records').textContent = '...';
		//		document.getElementById('today-records').textContent = '...';
		//		document.getElementById('total-words').textContent = '...';
		//		document.getElementById('week-words').textContent = '...';
		//		document.getElementById('online-users').textContent = '...';
		//		document.getElementById('recent-users').textContent = '...';
		//		// 如果有最近注册用户表格，也显示加载状态
		//		const recentUsersTable = document.getElementById('recent-users-table');
		//		if (recentUsersTable) {
		//			recentUsersTable.innerHTML = '<tr><td colspan="4" class="text-center">加载中...</td></tr>';
		//		}
		//
		//		// 2. 调用后端 API
		//		console.log('[admin.html] 正在请求 /api/admin/dashboard/stats');
		//		const response = await fetch('/api/admin/dashboard/stats', {
		//			method: 'GET',
		//			headers: {
		//				'Authorization': `Bearer ${token}`, // 确保携带认证 Token
		//				'Content-Type': 'application/json'
		//			}
		//		});
		//
		//		console.log('[admin.html] 收到 API 响应:', response.status, response.statusText);
		//
		//		// 3. 检查响应状态
		//		if (!response.ok) {
		//			// 尝试读取错误信息
		//			let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
		//			try {
		//				const errorData = await response.json();
		//				errorMsg = errorData.error || errorMsg;
		//			} catch (e) {
		//				// 如果无法解析 JSON 错误，就用默认的
		//			}
		//			throw new Error(errorMsg);
		//		}
		//
		//		// 4. 解析 JSON 数据
		//		const data = await response.json();
		//		console.log('[admin.html] 解析后的数据:', data);
		//
		//		// 5. 检查业务逻辑是否成功
		//		if (data.success && data.stats) {
		//			const stats = data.stats;
		//			console.log('[admin.html] 成功获取统计数据:', stats);
		//
		//			// 6. 更新 UI - 用户统计
		//			document.getElementById('total-users').textContent = stats.users.total ?? 0;
		//			document.getElementById('active-users').textContent = stats.users.active ?? 0;
		//			document.getElementById('online-users').textContent = stats.users.online ?? 0;
		//			document.getElementById('recent-users').textContent = stats.users.recent24h ?? 0;
		//
		//			// 7. 更新 UI - 学习记录统计
		//			document.getElementById('total-records').textContent = stats.learning.totalRecords ?? 0;
		//			document.getElementById('today-records').textContent = stats.learning.newToday ?? 0;
		//
		//			// 8. 更新 UI - 生词统计
		//			document.getElementById('total-words').textContent = stats.vocabulary.totalCore ?? 0;
		//			document.getElementById('week-words').textContent = stats.vocabulary.newThisWeek ?? 0;
		//
		//			9. 可选：更新最近注册用户表格 (如果后端返回了这个数据)
		//			如果后端 API 在 stats 中包含了 recentUsers 数组
		//			if (stats.recentUsers && Array.isArray(stats.recentUsers) && recentUsersTable) {
		//			    recentUsersTable.innerHTML = '';
		//			    if (stats.recentUsers.length === 0) {
		//			        recentUsersTable.innerHTML = '<tr><td colspan="4" class="text-center">暂无数据</td></tr>';
		//			    } else {
		//			        stats.recentUsers.forEach(user => {
		//			            const row = document.createElement('tr');
		//			            const regDate = user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A';
		//			            const loginDate = user.lastLogin ? new Date(user.lastLogin).toLocaleDateString() : '从未';
		//			            row.innerHTML = `
		//			                <td>${user.name || user.email}</td>
		//			                <td>${user.email}</td>
		//			                <td>${regDate}</td>
		//			                <td>${loginDate}</td>
		//			            `;
		//			            recentUsersTable.appendChild(row);
		//			        });
		//			    }
		//			} else if (recentUsersTable) {
		//			    // 如果没有 recentUsers 数据，或者格式不对
		//			    recentUsersTable.innerHTML = '<tr><td colspan="4" class="text-center">数据不可用</td></tr>';
		//			}
		//
		//		} else {
		//			// 后端返回了 JSON，但 success 为 false 或没有 stats
		//			const errorMsg = data.error || 'API 返回失败状态';
		//			throw new Error(errorMsg);
		//		}
		//
		//	} catch (error) {
		//		console.error('[admin.html] 加载仪表板数据失败:', error);
		//		// 显示错误信息到 UI
		//		const errorMessage = `加载失败: ${error.message}`;
		//		document.getElementById('total-users').textContent = '错误';
		//		document.getElementById('active-users').textContent = '错误';
		//		document.getElementById('total-records').textContent = '错误';
		//		document.getElementById('today-records').textContent = '错误';
		//		document.getElementById('total-words').textContent = '错误';
		//		document.getElementById('week-words').textContent = '错误';
		//		document.getElementById('online-users').textContent = '错误';
		//		document.getElementById('recent-users').textContent = '错误';
		//		
		//		const recentUsersTable = document.getElementById('recent-users-table');
		//		if (recentUsersTable) {
		//			recentUsersTable.innerHTML = `<tr><td colspan="4" class="text-center text-danger">${errorMessage}</td></tr>`;
		//		}
		//		
		//		// 可选：弹出 alert
		//		// alert(errorMessage);
		//	}
		//}

		// 确保这个函数在 loadDashboardData 之前或同级作用域内定义
		function formatDate(dateString) {
			if (!dateString) return '从未';
			const date = new Date(dateString);
			// 使用 toLocaleString 并指定选项以获得更一致的格式
			return date.toLocaleString('zh-CN', {
				year: 'numeric',
				month: '2-digit',
				day: '2-digit',
				hour: '2-digit',
				minute: '2-digit',
				second: '2-digit'
			}).replace(/\//g, '-'); // 将日期分隔符 / 替换为 -
		}

		async function loadDashboardData() {
			console.log('[admin.html] 开始加载仪表板数据...');
			const token = localStorage.getItem('token');
			if (!token) {
				console.error('[admin.html] 未找到 Token，无法加载仪表板数据');
				return;
			}
		
			try {
				// 1. 显示加载状态
				document.getElementById('total-users').textContent = '...';
				document.getElementById('active-users').textContent = '...';
				document.getElementById('total-records').textContent = '...';
				document.getElementById('today-records').textContent = '...';
				document.getElementById('total-words').textContent = '...';
				document.getElementById('week-words').textContent = '...';
				document.getElementById('online-users').textContent = '...';
				document.getElementById('recent-users').textContent = '...';
				
				// 获取最近注册用户表格元素
				const recentUsersTable = document.getElementById('recent-users-table');
				if (recentUsersTable) {
					// 在这里也显示加载状态
					recentUsersTable.innerHTML = '<tr><td colspan="4" class="text-center">加载中...</td></tr>';
				}
		
				// 2. 调用后端 API
				console.log('[admin.html] 正在请求 /api/admin/dashboard/stats');
				const response = await fetch('/api/admin/dashboard/stats', {
					method: 'GET',
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json'
					}
				});
		
				console.log('[admin.html] 收到 API 响应:', response.status, response.statusText);
		
				// 3. 检查响应状态
				if (!response.ok) {
					let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
					try {
						const errorData = await response.json();
						errorMsg = errorData.error || errorMsg;
					} catch (e) { }
					throw new Error(errorMsg);
				}
		
				// 4. 解析 JSON 数据
				const data = await response.json();
				console.log('[admin.html] 解析后的数据:', data); // *** 关键日志：检查 data 结构 ***
		
				// 5. 检查业务逻辑是否成功
				if (data.success && data.stats) { // *** 确保进入这个 if 分支 ***
					const stats = data.stats; 
					console.log('[admin.html] 成功获取统计数据:', stats);
					const recentUsersList = data.recentUsers; // *** 从 data 对象直接获取 recentUsers ***
					console.log('[admin.html] 成功获取统计数据:', stats);
					console.log('[admin.html] 成功获取最近用户列表:', recentUsersList); // *** 关键日志：检查 recentUsersList ***
		
					// 6. 更新 UI - 用户统计
					document.getElementById('total-users').textContent = stats.users.total ?? 0;
					document.getElementById('active-users').textContent = stats.users.active ?? 0;
					document.getElementById('online-users').textContent = stats.users.online ?? 0;
					document.getElementById('recent-users').textContent = stats.users.recent24h ?? 0; // 或其他你想要的数字
		
					// 7. 更新 UI - 学习记录统计
					document.getElementById('total-records').textContent = stats.learning.totalRecords ?? 0;
					document.getElementById('today-records').textContent = stats.learning.newToday ?? 0;
		
					// 8. 更新 UI - 生词统计
					document.getElementById('total-words').textContent = stats.vocabulary.totalCore ?? 0;
					document.getElementById('week-words').textContent = stats.vocabulary.newThisWeek ?? 0;
		
					// --- 关键修改：用 try...catch 包裹最近用户表格的渲染逻辑 ---
					try {
						// 获取最近注册用户表格元素
						const recentUsersTable = document.getElementById('recent-users-table');
						if (recentUsersTable) {
							// 从 data 对象直接获取 recentUsers 数组 (根据你后端的修改)
							const recentUsersList = data.recentUsers; 
							console.log('[admin.html] 准备渲染最近用户表格，用户数:', recentUsersList?.length);
		
							if (recentUsersList && Array.isArray(recentUsersList)) {
								recentUsersTable.innerHTML = ''; // 清空现有内容
		
								if (recentUsersList.length === 0) {
									recentUsersTable.innerHTML = '<tr><td colspan="4" class="text-center">暂无最近注册用户</td></tr>';
								} else {
									recentUsersList.forEach(user => {
										const row = document.createElement('tr');
										// --- 关键：确保 formatDate 函数已定义并正确调用 ---
										const regDateStr = user.createdAt ? formatDate(user.createdAt) : 'N/A';
										const lastLoginStr = user.lastLogin ? formatDate(user.lastLogin) : '从未';
										// --- 关键结束 ---
										row.innerHTML = `
											<td>${user.name || user.email || '-'}</td>
											<td>${user.email || '-'}</td>
											<td>${regDateStr}</td>
											<td>${lastLoginStr}</td>
										`;
										recentUsersTable.appendChild(row);
									});
								}
							} else {
								console.warn('[admin.html] 后端返回的 recentUsers 数据格式不正确或为空:', recentUsersList);
								recentUsersTable.innerHTML = '<tr><td colspan="4" class="text-center">暂无数据</td></tr>';
							}
						} else {
							console.warn('[admin.html] 未找到 ID 为 recent-users-table 的元素');
						}
					} catch (renderError) {
						// --- 捕获并处理渲染最近用户表格时的任何错误 ---
						console.error('[admin.html] 渲染最近注册用户表格时出错:', renderError);
						const recentUsersTable = document.getElementById('recent-users-table');
						if (recentUsersTable) {
							recentUsersTable.innerHTML = `<tr><td colspan="4" class="text-center text-danger">表格渲染失败: ${renderError.message}</td></tr>`;
						}
						// --- 错误处理结束 ---
					}
					// --- 最近用户表格渲染结束 ---
		
		
				} else {
					throw new Error(data.error || 'API 返回失败状态');
				}
		
			} catch (error) {
				console.error('[admin.html] 加载仪表板数据失败:', error);
				// --- 关键修改：即使主逻辑出错，也尝试更新最近用户表格的错误状态 ---
				const recentUsersTable = document.getElementById('recent-users-table');
				if (recentUsersTable) {
					recentUsersTable.innerHTML = `<tr><td colspan="4" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
				}
				// --- 修改结束 ---
				
				// 显示错误信息到其他 UI 元素
				const errorMessage = `加载失败: ${error.message}`;
				document.getElementById('total-users').textContent = '错误';
				document.getElementById('active-users').textContent = '错误';
				document.getElementById('total-records').textContent = '错误';
				document.getElementById('today-records').textContent = '错误';
				document.getElementById('total-words').textContent = '错误';
				document.getElementById('week-words').textContent = '错误';
				document.getElementById('online-users').textContent = '错误';
				document.getElementById('recent-users').textContent = '错误'; // 更新 "最近24小时" 的显示
			}
		}


		
		// --- 发送删除请求的函数 ---
		async function deleteUserData(userId) {
			const token = localStorage.getItem('token');
			if (!token) {
				alert('未登录，请重新登录。');
				return;
			}
		
			try {
				console.log(`[admin.html] 正在删除用户 ID: ${userId}`);
				const response = await fetch(`/api/admin/users/${userId}`, {
					method: 'DELETE',
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json'
					}
				});
		
				if (!response.ok) {
					let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
					try {
						const errorData = await response.json();
						errorMsg = errorData.error || errorMsg;
					} catch (e) {}
					throw new Error(errorMsg);
				}
		
				const data = await response.json();
				if (data.success) {
					alert(`用户删除成功！`);
					// 删除成功后，刷新用户列表
					loadUsers(currentUsersPage);
				} else {
					throw new Error(data.error || '删除用户失败。');
				}
		
			} catch (error) {
				console.error('[admin.html] 删除用户失败:', error);
				alert('删除用户失败: ' + error.message);
			}
		}

		
        // 加载最近用户
        async function loadRecentUsers() {
            try {
                // 模拟最近用户数据
                const recentUsers = [
                    { name: '刘备', email: 'zhangsan@example.com', createdAt: '2024-01-15', lastLogin: '2024-01-20' },
                    { name: '关羽', email: 'lisi@example.com', createdAt: '2024-01-14', lastLogin: '2024-01-19' },
                    { name: '张飞', email: 'wangwu@example.com', createdAt: '2024-01-13', lastLogin: '2024-01-18' }
                ];
                
                const tableBody = document.getElementById('recent-users-table');
                tableBody.innerHTML = '';
                
                recentUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.createdAt}</td>
                        <td>${user.lastLogin}</td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('加载最近用户失败:', error);
            }
        }

        // 加载用户列表
        //async function loadUsers(page = 1) {
        //    try {
        //        // 这里应该调用后端API获取用户列表
        //        // 暂时使用模拟数据
        //        const users = [
        //            { id: '1', name: '刘备', email: 'zhangsan@example.com', createdAt: '2024-01-15', lastLogin: '2024-01-20', status: 'active' },
        //            { id: '2', name: '关羽', email: 'lisi@example.com', createdAt: '2024-01-14', lastLogin: '2024-01-19', status: 'active' },
        //            { id: '3', name: '张飞', email: 'wangwu@example.com', createdAt: '2024-01-13', lastLogin: '2024-01-18', status: 'inactive' }
        //        ];
        //        
        //        const tableBody = document.getElementById('users-table-body');
        //        tableBody.innerHTML = '';
        //        
        //        users.forEach(user => {
        //            const row = document.createElement('tr');
        //            row.innerHTML = `
        //                <td>${user.name}</td>
        //                <td>${user.email}</td>
        //                <td>${user.createdAt}</td>
        //                <td>${user.lastLogin || '从未登录'}</td>
        //                <td>
        //                    <span class="badge ${user.status === 'active' ? 'bg-success' : 'bg-secondary'}">
        //                        ${user.status === 'active' ? '活跃' : '非活跃'}
        //                    </span>
        //                </td>
        //                <td>
        //                    <button class="btn btn-sm btn-outline-primary me-1" onclick="editUser('${user.id}')">
        //                        <i class="bi bi-pencil"></i>
        //                    </button>
        //                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">
        //                        <i class="bi bi-trash"></i>
        //                    </button>
        //                </td>
        //            `;
        //            tableBody.appendChild(row);
        //        });
        //        
        //        // 更新分页
        //        updateUsersPagination(1, 1);
        //    } catch (error) {
        //        console.error('加载用户列表失败:', error);
        //        document.getElementById('users-table-body').innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败</td></tr>';
        //    }
        //}

		// --- 渲染用户列表表格的函数 ---
		function renderUsersTable(users) {
			console.log('[admin.html] 开始渲染用户表格，用户数:', users?.length);
			const tableBody = document.getElementById('users-table-body');
		
			if (!tableBody) {
				console.error('[admin.html] 未找到 ID 为 users-table-body 的元素');
				return;
			}
		
			tableBody.innerHTML = '';
		
			if (!users || !Array.isArray(users) || users.length === 0) {
				console.log('[admin.html] 用户列表为空或无效');
				// 注意：确保表格的列数与此处的 colspan 匹配
				tableBody.innerHTML = '<tr><td colspan="7" class="text-center">暂无用户数据</td></tr>'; 
				return;
			}
		
			users.forEach((user, index) => {
				const row = document.createElement('tr');
		
				const createdAtStr = user.createdAt ? formatDate(user.createdAt) : 'N/A';
				const lastLoginStr = user.lastLogin ? formatDate(user.lastLogin) : '从未';
		
				let statusBadge = '<span class="badge bg-secondary">未知</span>';
				if (user.lastLogin) {
					const oneWeekAgo = new Date();
					oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
					if (new Date(user.lastLogin) >= oneWeekAgo) {
						statusBadge = '<span class="badge bg-success">活跃</span>';
					} else {
						statusBadge = '<span class="badge bg-warning text-dark">非活跃</span>';
					}
				} else {
					statusBadge = '<span class="badge bg-secondary">未登录</span>';
				}
		
				// --- 关键修改 1: 移除按钮的 disabled 类 ---
				// --- 关键修改 2: 为按钮添加 data-* 属性，便于事件处理函数获取信息 ---
				row.innerHTML = `
					<th scope="row">${(currentUsersPage - 1) * usersPerPage + index + 1}</th> <!-- 显示全局序号 -->
					<td>${user.name || '-'}</td>
					<td>${user.email}</td>
					<td>${createdAtStr}</td>
					<td>${lastLoginStr}</td>
					<td>${statusBadge}</td>
					<td>
						<!-- 移除了 disabled 类，并添加了 data-id 和 data-name 属性 -->
						<button class="btn btn-sm btn-outline-primary edit-user-btn me-1" data-id="${user._id}" data-user='${JSON.stringify({ id: user._id, name: user.name, email: user.email })}'>
							<i class="bi bi-pencil"></i> 编辑
						</button>
						<button class="btn btn-sm btn-outline-danger delete-user-btn" data-id="${user._id}" data-name="${user.name || user.email}">
							<i class="bi bi-trash"></i> 删除
						</button>
					</td>
				`;
				tableBody.appendChild(row);
			});
		
			// --- 关键修改 3: 在 HTML 插入 DOM 后，为新生成的按钮绑定事件监听器 ---
			// 为所有 "编辑" 按钮绑定点击事件
			document.querySelectorAll('.edit-user-btn').forEach(btn => {
				btn.addEventListener('click', function(e) {
					e.preventDefault(); // 阻止默认行为（虽然是 button，但以防万一）
					const userId = this.getAttribute('data-id');
					const userDataJson = this.getAttribute('data-user');
					let userData;
					try {
						userData = JSON.parse(userDataJson);
					} catch (parseErr) {
						console.error('[admin.html] 解析用户数据失败:', parseErr);
						alert('无法加载用户数据进行编辑');
						return;
					}
					console.log(`[admin.html] 用户点击编辑按钮，用户 ID: ${userId}`);
					// 调用处理编辑逻辑的函数
					handleEditUser(userId, userData); 
				});
			});
		
			// 为所有 "删除" 按钮绑定点击事件
			document.querySelectorAll('.delete-user-btn').forEach(btn => {
				btn.addEventListener('click', function(e) {
					e.preventDefault();
					const userId = this.getAttribute('data-id');
					const userName = this.getAttribute('data-name');
					console.log(`[admin.html] 用户点击删除按钮，用户 ID: ${userId}, 用户名: ${userName}`);
					// 调用处理删除逻辑的函数
					handleDeleteUser(userId, userName);
				});
			});
			// --- 修改结束 ---
		
			console.log('[admin.html] 用户表格渲染完成');
		}

		// --- 处理编辑用户逻辑的函数 ---
		function handleEditUser(userId, userData) {
			console.log(`[admin.html] 处理编辑用户逻辑，用户 ID: ${userId}`, userData);
			// 这里可以弹出一个模态框，从后端获取该用户的详细信息并填充表单
			// 由于没有预先定义模态框，我们可以先用一个简单的 alert 提示
			// 或者，如果简单编辑（如只改名），可以直接 prompt
			const newName = prompt(`请输入用户 "${userData.name || userData.email}" 的新姓名:`, userData.name || '');
			if (newName !== null && newName.trim() !== '' && newName.trim() !== (userData.name || '')) {
				// 用户输入了新名字且不为空，也不等于原名，则调用更新 API
				updateUser(userId, { name: newName.trim() });
			} else if (newName !== null) {
				// 用户输入了空名字或取消了操作
				if (newName.trim() === '') {
					alert('姓名不能为空。');
				} // 如果是取消，就不做任何事
			}
			// 在实际应用中，你应该调用一个函数来打开一个完整的编辑模态框，例如 openEditUserModal(userId)
			// openEditUserModal(userId);
		}
		
		// --- 处理删除用户逻辑的函数 ---
		function handleDeleteUser(userId, userName) {
			console.log(`[admin.html] 处理删除用户逻辑，用户 ID: ${userId}, 用户名: ${userName}`);
			// 弹出确认对话框
			if (confirm(`确定要删除用户 "${userName}" 吗？此操作不可恢复！`)) {
				// 用户确认删除，调用后端 API
				deleteUserData(userId);
			}
		}
		
		// --- 调用后端 API 更新用户信息的函数 (简化版) ---
		async function updateUser(userId, updateData) {
			const token = localStorage.getItem('token');
			if (!token) {
				alert('未登录，请重新登录。');
				return;
			}
		
			try {
				console.log(`[admin.html] 正在更新用户 ID ${userId} 的信息:`, updateData);
				const response = await fetch(`/api/admin/users/${userId}`, {
					method: 'PUT', // 确保后端有对应的 PUT 路由
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(updateData)
				});
		
				if (!response.ok) {
					let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
					try {
						const errorData = await response.json();
						errorMsg = errorData.error || errorMsg;
					} catch (e) {}
					throw new Error(errorMsg);
				}
		
				const data = await response.json();
				if (data.success) {
					alert(`用户 "${data.user?.name || data.user?.email || '未知'}" 信息更新成功！`);
					// 更新成功后，刷新用户列表
					loadUsers(currentUsersPage);
				} else {
					throw new Error(data.error || '更新用户信息失败。');
				}
		
			} catch (error) {
				console.error('[admin.html] 更新用户信息失败:', error);
				alert('更新用户信息失败: ' + error.message);
			}
		}

		//function renderUsersTable(users) {
		//	console.log('[admin.html] 开始渲染用户表格，用户数:', users?.length);
		//	const tableBody = document.getElementById('users-table-body');
		//	
		//	// 基本检查
		//	if (!tableBody) {
		//		console.error('[admin.html] 未找到 ID 为 users-table-body 的元素');
		//		return;
		//	}
		//
		//	// 清空现有内容
		//	tableBody.innerHTML = '';
		//
		//	// 检查用户数据
		//	if (!users || !Array.isArray(users) || users.length === 0) {
		//		console.log('[admin.html] 用户列表为空或无效');
		//		tableBody.innerHTML = '<tr><td colspan="6" class="text-center">暂无用户数据</td></tr>';
		//		return;
		//	}
		//
		//	// 遍历用户数据并生成表格行
		//	users.forEach((user, index) => {
		//		const row = document.createElement('tr');
		//		
		//		// 格式化日期 (复用之前定义的 formatDate 函数)
		//		const createdAtStr = user.createdAt ? formatDate(user.createdAt) : 'N/A';
		//		const lastLoginStr = user.lastLogin ? formatDate(user.lastLogin) : '从未';
		//
		//		// 简单判断活跃状态 (可以根据 lastLogin 时间差判断)
		//		let statusBadge = '<span class="badge bg-secondary">未知</span>';
		//		if (user.lastLogin) {
		//			const oneWeekAgo = new Date();
		//			oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
		//			if (new Date(user.lastLogin) >= oneWeekAgo) {
		//				statusBadge = '<span class="badge bg-success">活跃</span>';
		//			} else {
		//				statusBadge = '<span class="badge bg-warning text-dark">非活跃</span>';
		//			}
		//		} else {
		//			statusBadge = '<span class="badge bg-secondary">未登录</span>';
		//		}
		//
		//		// 填充表格行内容
		//		row.innerHTML = `
		//			<th scope="row">${index + 1}</th>
		//			<td>${user.name || '-'}</td>
		//			<td>${user.email}</td>
		//			<td>${createdAtStr}</td>
		//			<td>${lastLoginStr}</td>
		//			<td>${statusBadge}</td>
		//			<!-- 可以在这里添加编辑/删除按钮 -->
		//			<td>
		//				<button class="btn btn-sm btn-outline-primary disabled" title="编辑功能待实现">编辑</button>
		//				<button class="btn btn-sm btn-outline-danger disabled" title="删除功能待实现">删除</button>
		//			</td>
		//		`;
		//		tableBody.appendChild(row);
		//	});
		//	console.log('[admin.html] 用户表格渲染完成');
		//}
		
		
		// --- 渲染用户列表分页控件的函数 ---
		function renderUsersPagination(paginationData) {
			console.log('[admin.html] 开始渲染用户分页控件:', paginationData);
			const paginationControls = document.getElementById('users-pagination');
			
			// 基本检查
			if (!paginationControls) {
				console.error('[admin.html] 未找到 ID 为 users-pagination 的元素');
				return;
			}
		
			// 清空现有内容
			paginationControls.innerHTML = '';
		
			// 检查分页数据
			if (!paginationData || typeof paginationData !== 'object') {
				console.log('[admin.html] 分页数据无效');
				// paginationControls.innerHTML = '<li class="page-item disabled"><span class="page-link">分页信息无效</span></li>';
				return; // 如果没有分页信息，就隐藏或不显示分页控件
			}
		
			const { currentPage, totalPages } = paginationData;
		
			if (totalPages <= 1) {
				// 如果只有一页或没有页，则不显示分页控件
				console.log('[admin.html] 总页数小于等于1，不显示分页控件');
				return;
			}
		
			// Previous button
			const prevLi = document.createElement('li');
			prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
			prevLi.innerHTML = `<a class="page-link" href="#" ${currentPage > 1 ? `data-page="${currentPage - 1}"` : ''}>上一页</a>`;
			if (currentPage > 1) {
				prevLi.querySelector('a').addEventListener('click', (e) => {
					e.preventDefault();
					console.log(`[admin.html] 用户点击上一页: ${currentPage - 1}`);
					loadUsers(currentPage - 1);
				});
			}
			paginationControls.appendChild(prevLi);
		
			// Page numbers (简化显示，例如当前页和前后两页)
			const startPage = Math.max(1, currentPage - 2);
			const endPage = Math.min(totalPages, currentPage + 2);
		
			for (let i = startPage; i <= endPage; i++) {
				const pageLi = document.createElement('li');
				pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
				if (i === currentPage) {
					pageLi.innerHTML = `<span class="page-link">${i}</span>`; // 当前页用 span
				} else {
					pageLi.innerHTML = `<a class="page-link" href="#" data-page="${i}">${i}</a>`;
					pageLi.querySelector('a').addEventListener('click', (e) => {
						e.preventDefault();
						const pageToLoad = parseInt(e.currentTarget.getAttribute('data-page'));
						console.log(`[admin.html] 用户点击页码: ${pageToLoad}`);
						loadUsers(pageToLoad);
					});
				}
				paginationControls.appendChild(pageLi);
			}
		
			// Next button
			const nextLi = document.createElement('li');
			nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
			nextLi.innerHTML = `<a class="page-link" href="#" ${currentPage < totalPages ? `data-page="${currentPage + 1}"` : ''}>下一页</a>`;
			if (currentPage < totalPages) {
				nextLi.querySelector('a').addEventListener('click', (e) => {
					e.preventDefault();
					console.log(`[admin.html] 用户点击下一页: ${currentPage + 1}`);
					loadUsers(currentPage + 1);
				});
			}
			paginationControls.appendChild(nextLi);
			
			console.log('[admin.html] 用户分页控件渲染完成');
		}
		

		async function loadUsers(page = 1) {
			console.log(`[admin.html] 开始加载用户列表 (第 ${page} 页)...`);
			const tableBody = document.getElementById('users-table-body');
			const paginationControls = document.getElementById('users-pagination');
		
			// 1. 显示加载状态
			tableBody.innerHTML = '<tr><td colspan="6" class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></td></tr>';
			paginationControls.innerHTML = '<li class="page-item disabled"><span class="page-link">加载中...</span></li>';
		
			// --- 关键修改：修复变量声明错误 ---
			// let currentUsersPage = page; // 错误：重复声明
			currentUsersPage = page; // 正确：修改全局变量
			// --- 修改结束 ---
		
			// 2. 获取 Token
			const token = localStorage.getItem('token');
			if (!token) {
				console.error('[admin.html] 未找到 Token');
				tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">未登录</td></tr>';
				paginationControls.innerHTML = '';
				return;
			}
		
			try {
				// 3. 构建 API 查询参数
				const params = new URLSearchParams({
					page: page,
					limit: usersPerPage, // 使用全局常量
					// sort: 'createdAt_desc', // 可以添加默认排序
					// status: '', // 可以添加默认筛选
					// search: '' // 可以添加默认搜索
				});
		
				// 4. 调用后端 API (使用 fetch 或 api.js)
				// --- 使用 fetch ---
				const response = await fetch(`/api/admin/users?${params.toString()}`, {
					method: 'GET',
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json'
					}
				});
				// --- fetch 结束 ---
		
				if (!response.ok) {
					// 尝试解析错误信息
					let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
					try {
						const errorData = await response.json();
						errorMsg = errorData.error || errorMsg;
					} catch (e) {
						// 解析失败，使用默认信息
					}
					throw new Error(errorMsg);
				}
		
				const data = await response.json();
		
				// 5. 处理响应数据
				if (data.success) {
					console.log('[admin.html] 成功获取用户列表:', data);
					renderUsersTable(data.users); // 渲染用户表格
					renderUsersPagination(data.pagination); // 渲染分页控件
				} else {
					throw new Error(data.error || '获取用户列表失败');
				}
		
			} catch (error) {
				console.error('[admin.html] 加载用户列表失败:', error);
				tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-danger">加载失败: ${error.message}</td></tr>`;
				paginationControls.innerHTML = '';
			}
		}

        // 更新用户分页
        function updateUsersPagination(currentPage, totalPages) {
            const pagination = document.getElementById('users-pagination');
            pagination.innerHTML = '';
            
            // 上一页
            const prevItem = document.createElement('li');
            prevItem.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
            prevItem.innerHTML = '<a class="page-link" href="#">上一页</a>';
            pagination.appendChild(prevItem);
            
            // 页码
            for (let i = 1; i <= totalPages; i++) {
                const pageItem = document.createElement('li');
                pageItem.className = 'page-item' + (i === currentPage ? ' active' : '');
                pageItem.innerHTML = `<a class="page-link" href="#" onclick="loadUsers(${i})">${i}</a>`;
                pagination.appendChild(pageItem);
            }
            
            // 下一页
            const nextItem = document.createElement('li');
            nextItem.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
            nextItem.innerHTML = '<a class="page-link" href="#">下一页</a>';
            pagination.appendChild(nextItem);
        }

        // 刷新用户列表
        function refreshUsers() {
            loadUsers(currentUsersPage);
        }

        // 显示添加用户模态框
        function showAddUserModal() {
            document.getElementById('add-user-form').reset();
            const modal = new bootstrap.Modal(document.getElementById('addUserModal'));
            modal.show();
        }

        //// 添加用户
		async function addUser() {
			console.log('[admin.html] 用户点击添加用户按钮');
		
			// 获取表单数据
			const name = document.getElementById('user-name').value.trim();
			const email = document.getElementById('user-email').value.trim();
			const password = document.getElementById('user-password').value;
			const phone = document.getElementById('user-phone').value.trim(); // 假设电话是可选的
			// 可以根据你的 User 模型添加更多字段...
		
			// 验证必填字段
			if (!name || !email || !password) {
				alert('姓名、邮箱和密码不能为空。');
				return;
			}
		
			// 验证邮箱格式（简单正则）
			const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
			if (!emailRegex.test(email)) {
				alert('请输入有效的邮箱地址。');
				return;
			}
		
			// 验证密码长度（例如至少6位）
			if (password.length < 6) {
				alert('密码长度至少需要6位。');
				return;
			}
		
			// 准备要发送给后端的数据
			const userData = {
				name: name,
				email: email,
				password: password,
				// phone: phone, // 如果电话是必填或可选，可以包含在内
				// 其他字段...
			};
		
			// 获取 Token
			const token = localStorage.getItem('token');
			if (!token) {
				alert('未登录，请重新登录。');
				return;
			}
		
			// 显示加载状态（可选，提升用户体验）
			const saveBtn = document.querySelector('#addUserModal .btn-primary'); // 找到模态框中的保存按钮
			const originalText = saveBtn.innerHTML;
			saveBtn.disabled = true;
			saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> 添加中...';
		
			try {
				// --- 关键修改：调用后端 API 创建用户 ---
				// 使用 fetch 发送 POST 请求
				const response = await fetch('/api/admin/users', { // 确保此路由存在
					method: 'POST',
					headers: {
						'Authorization': `Bearer ${token}`,
						'Content-Type': 'application/json'
					},
					body: JSON.stringify(userData)
				});
		
				// 检查响应状态
				if (!response.ok) {
					let errorMsg = `HTTP ${response.status}: ${response.statusText}`;
					try {
						const errorData = await response.json();
						errorMsg = errorData.error || errorMsg;
					} catch (e) {}
					throw new Error(errorMsg);
				}
		
				// 解析成功响应
				const data = await response.json();
				if (data.success) {
					console.log('[admin.html] 用户添加成功:', data);
					alert(`用户 "${name}" 添加成功！`);
					// 关闭模态框
					const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
					modal.hide();
					// 刷新用户列表
					loadUsers(currentUsersPage);
				} else {
					throw new Error(data.error || '添加用户失败。');
				}
		
			} catch (error) {
				console.error('[admin.html] 添加用户失败:', error);
				alert('添加用户失败: ' + error.message);
			} finally {
				// 恢复按钮状态
				saveBtn.disabled = false;
				saveBtn.innerHTML = originalText;
			}
		}

        // 编辑用户
        function editUser(userId) {
            // 这里应该从后端获取用户详细信息并填充表单
            alert('编辑用户功能正在开发中...');
        }

        // 更新用户
        async function updateUser() {
            alert('更新用户功能正在开发中...');
        }

        // 删除用户
        async function deleteUser(userId) {
            if (confirm('确定要删除这个用户吗？此操作不可恢复！')) {
                try {
                    // 这里应该调用后端API删除用户
                    alert('用户删除成功！');
                    loadUsers(currentUsersPage);
                } catch (error) {
                    alert('删除用户失败: ' + error.message);
                }
            }
        }

        // 加载学习记录
        async function loadLearningRecords() {
            try {
                // 模拟学习记录数据
                const records = [
                    { user: '刘备', content: '小学英语第1课', duration: 25, score: 85, date: '2024-01-20' },
                    { user: '关羽', content: '初中语法练习', duration: 35, score: 78, date: '2024-01-19' },
                    { user: '张飞', content: '英语听力训练', duration: 20, score: 92, date: '2024-01-18' }
                ];
                
                const tableBody = document.getElementById('learning-records-table');
                tableBody.innerHTML = '';
                
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${record.user}</td>
                        <td>${record.content}</td>
                        <td>${record.duration}</td>
                        <td>${record.score}%</td>
                        <td>${record.date}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary me-1">
                                <i class="bi bi-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                console.error('加载学习记录失败:', error);
                document.getElementById('learning-records-table').innerHTML = '<tr><td colspan="6" class="text-center text-danger">加载失败</td></tr>';
            }
        }

        // 刷新学习记录
        function refreshLearningRecords() {
            loadLearningRecords();
        }

        // 登出功能
        document.getElementById('logout-btn').addEventListener('click', () => {
            api.logout();
            window.location.href = 'index.html';
        });

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('[admin.html] DOMContentLoaded 事件触发');
			// 检查管理员权限
            const isAdmin = await checkAdminAccess();
            if (!isAdmin) {
                console.log('[admin.html] 用户不是管理员或权限检查失败');
				return;
            }
            console.log('[admin.html] 用户是管理员，准备加载仪表板数据');
            // 设置标签页导航
            setupTabNavigation();
            
            // 默认加载仪表板数据
            loadDashboardData();
        });
    </script>
</body>
</html>