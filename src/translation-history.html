<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>翻译记录 - 立信英语</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
    <style>
        /* 复用或模仿 vocabulary-book.html 的样式 */
        .translation-record-container {
            /* max-height: 600px;  如果需要固定高度和内部滚动条可以取消注释 */
            /* overflow-y: auto;   超出时显示垂直滚动条 */
        }
        .table th {
            position: sticky; /* 使表头在滚动时固定 */
            top: 0;
            background-color: #f8f9fa; /* Bootstrap card background color */
            z-index: 10; /* 确保表头在内容之上 */
        }
         /* 加载指示器样式 */
         .loading-spinner {
            display: inline-block;
            width: 1rem;
            height: 1rem;
            vertical-align: text-bottom;
            border: 0.2em solid currentColor;
            border-right-color: transparent;
            border-radius: 50%;
            animation: spinner-border 0.75s linear infinite;
        }
        @keyframes spinner-border {
            to { transform: rotate(360deg); }
        }

        /* --- 新增：自定义翻译记录卡片样式 --- */
        .translation-record-card {
            border-radius: 0.5rem; /* 圆角 */
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); /* 轻微阴影 */
            transition: box-shadow 0.15s ease-in-out; /* 悬停效果过渡 */
            margin-bottom: 1.5rem; /* 卡片之间的间距 */
            border: 1px solid rgba(0, 0, 0, 0.125); /* 轻微边框 */
        }
        .translation-record-card:hover {
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); /* 悬停时加深阴影 */
        }
        .original-sentence {
            font-weight: bold; /* 原文加粗 */
            margin-bottom: 1rem; /* 与下方翻译区域的间距 */
            padding: 1rem 1rem 0 1rem; /* 内边距 */
        }
        .translations-row {
            padding: 0 1rem 1rem 1rem; /* 内边距 */
        }
        .translation-box {
            border-radius: 0.375rem; /* 翻译框圆角 */
            padding: 1rem; /* 内边距 */
            min-height: 80px; /* 最小高度，保持一致性 */
        }
        .ai-translation-box {
            background-color: #e8f5e9; /* 浅绿色背景 */
            border-left: 4px solid #28a745; /* 左侧绿色边框 */
        }
        .user-translation-box {
            background-color: #fff3cd; /* 浅黄色背景 (Bootstrap 的 warning 背景色) */
            border-left: 4px solid #ffc107; /* 左侧黄色边框 (Bootstrap 的 warning 边框色) */
        }
        .translation-label {
            font-weight: 500; /* 标签稍微加粗 */
            margin-bottom: 0.25rem; /* 与翻译内容的间距 */
            display: block; /* 确保标签独占一行 */
        }
		/* 评分显示样式 */
		.score-display {
			/* margin-top: 0.5rem; 已在 createElement 中设置 */
			/* font-size: 0.9rem; 已在 createElement 中设置 */
			/* font-weight: bold; 已在 createElement 中设置 */
			display: flex;
			align-items: center; /* 垂直居中图标和文字 */
		}
		
		.score-display i {
			margin-right: 0.5rem; /* 图标和文字之间的间距 */
		}
		
		/* 可选：为卡片添加一点底部边距，使卡片之间有空隙 */
		.translation-record-card {
			margin-bottom: 1rem;
		}
    </style>
</head>
<body>
    <!-- 导航栏 (与 vocabulary-book.html 保持一致) -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white fixed-top shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="index.html">立信英语</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="index.html">首页</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#about">关于</a></li>
                    <li class="nav-item"><a class="nav-link" href="index.html#services">服务</a></li>
                    <li class="nav-item"><a class="nav-link" href="si-nian-ji.html">文章</a></li>
                    <!-- 登录状态显示 - 添加的部分 -->
                    <li class="nav-item">
                        <span id="user-info" class="navbar-text me-2 d-none"></span>
                        <a href="profile.html" class="btn btn-outline-primary btn-sm me-1 d-none" id="profile-btn">个人中心</a>
                        <a href="learning-records.html" class="btn btn-outline-info btn-sm me-1 d-none" id="records-btn">学习记录</a>
                        <a href="admin-vocabulary.html" class="btn btn-outline-warning btn-sm me-1 d-none" id="admin-btn">管理员</a>
                        <button id="login-btn" class="btn btn-outline-primary btn-sm me-1">登录</button>
                        <button id="logout-btn" class="btn btn-outline-secondary btn-sm d-none">登出</button>
                    </li>
                    <!-- 登录状态显示结束 -->
                    <li class="nav-item"><a class="nav-link" href="index.html#contact">联系</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- 页面内容 -->
    <div class="container mt-5 pt-5">
        <div class="row">
            <!-- 侧边栏 (与 vocabulary-book.html 保持一致) -->
            <div class="col-lg-3 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5>学习报告</h5>
                    </div>
                    <div class="list-group list-group-flush">
                        <a href="learning-records.html" class="list-group-item list-group-item-action">词汇测试历史</a>
                        <a href="vocabulary-book.html" class="list-group-item list-group-item-action">生词表</a>
						<a href="#" class="list-group-item list-group-item-action active">学习汇总</a>
                        <a href="data-export.html" class="list-group-item list-group-item-action ">数据导出</a>
                    </div>
                </div>
            </div>

            <!-- 主要内容区域 -->
            <div class="col-lg-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">我的翻译记录</h4>
                        <div>
                            <!-- 刷新按钮 -->
                            <button id="refresh-btn" class="btn btn-outline-primary btn-sm">
                                <i class="bi bi-arrow-clockwise"></i> 刷新
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="message" class="alert d-none" role="alert"></div>

                        <!-- 翻译记录容器 (使用卡片布局) -->
                        <div class="translation-record-container">
                            <div id="translation-records-container">
                                <!-- 记录将在这里动态添加 -->
                                <div class="text-center text-muted">正在加载翻译记录...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 页脚 (与 vocabulary-book.html 保持一致) -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <p class="mb-0">&copy; 2024 立信英语. 保留所有权利.</p>
                </div>
                <div class="col-md-6 text-md-end">
                    <p class="mb-0">用心打造高效英语学习平台</p>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- 引入 api.js 以处理 token -->
    <script src="api.js"></script>
    <script>
        // --- 翻译记录管理系统 ---
        class TranslationHistoryManager {
            constructor() {
                //this.apiBaseUrl = window.ApiBaseUrl || 'http://localhost:3000/api'; // 从 api.js 获取
                this.apiBaseUrl = '/api';
				this.init();
            }

            init() {
                this.checkAuth(); // 检查登录状态
                this.loadTranslationRecords(); // 初始化时加载记录
                this.bindEvents(); // 绑定事件
            }

            bindEvents() {
                document.getElementById('refresh-btn')?.addEventListener('click', () => {
                    this.loadTranslationRecords();
                });
                document.getElementById('logout-btn')?.addEventListener('click', () => {
                    localStorage.removeItem('token');
                    window.location.href = 'index.html';
                });
                document.getElementById('login-btn')?.addEventListener('click', () => {
                    window.location.href = 'login.html';
                });
            }

            // 检查登录状态 (与 vocabulary-book.html 保持一致)
            async checkAuth() {
                const token = localStorage.getItem('token');
                const userInfo = document.getElementById('user-info');
                const profileBtn = document.getElementById('profile-btn');
                const recordsBtn = document.getElementById('records-btn');
                const adminBtn = document.getElementById('admin-btn');
                const loginBtn = document.getElementById('login-btn');
                const logoutBtn = document.getElementById('logout-btn');
                if (!token) {
                    loginBtn.classList.remove('d-none');
                    document.getElementById('translation-records-container').innerHTML = '<div class="text-center">请先 <a href="login.html">登录</a> 查看您的翻译记录。</div>';
                    return;
                }
                try {
                    const response = await fetch(`${this.apiBaseUrl}/user`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    const result = await response.json();
                    if (result.success) {
                        const user = result.user;
                        userInfo.textContent = `欢迎, ${user.name || user.email}`;
                        userInfo.classList.remove('d-none');
                        profileBtn.classList.remove('d-none');
                        recordsBtn.classList.remove('d-none');
                        const adminEmails = ['admin@example.com', 'admin@liuxinenglish.com'];
                        if (adminEmails.includes(user.email)) {
                            adminBtn.classList.remove('d-none');
                        }
                        loginBtn.classList.add('d-none');
                        logoutBtn.classList.remove('d-none');
                    } else {
                        throw new Error(result.error);
                    }
                } catch (error) {
                    console.error('检查登录状态失败:', error);
                    localStorage.removeItem('token');
                }
            }

            // 显示消息 (与 vocabulary-book.html 保持一致)
            showMessage(text, type) {
                const messageDiv = document.getElementById('message');
                messageDiv.textContent = text;
                messageDiv.className = `alert alert-${type} d-block`;
                setTimeout(() => {
                    messageDiv.classList.add('d-none');
                }, 5000);
            }

            // --- 修改：加载翻译记录数据到卡片布局 ---
            async loadTranslationRecords() {
                try {
                    this.showMessage('正在加载翻译记录...', 'info');
                    const token = localStorage.getItem('token');
                    if (!token) {
                        throw new Error('未登录');
                    }

					const response = await fetch(`${this.apiBaseUrl}/translation-records`, {
						method: 'GET',
						headers: {
							'Authorization': `Bearer ${token}`,
							'Content-Type': 'application/json'
						},
						cache: 'no-store' // <-- 强制浏览器不使用缓存，直接请求服务器
					});

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.error || `加载失败: ${response.status}`);
						throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log("从后端获取的翻译记录数据:", result);

                    const container = document.getElementById('translation-records-container');
                    container.innerHTML = ''; // 清空现有内容

                    if (result.success) {
                        const records = result.records || [];
                        if (records.length === 0) {
                             container.innerHTML = '<div class="text-center text-muted">您的翻译记录是空的。</div>';
                             this.showMessage('翻译记录加载完成，但列表为空。', 'warning');
                             return;
                        }

                        //records.forEach((record, index) => {
                        //    const addedDate = record.createdAt ? new Date(record.createdAt).toLocaleString() : 'N/A';
						//
                        //    // --- 创建卡片元素 ---
                        //    const card = document.createElement('div');
                        //    card.className = 'translation-record-card card';
                        //    
                        //    // --- 创建卡片主体 ---
                        //    const cardBody = document.createElement('div');
                        //    cardBody.className = 'card-body';
						//
                        //    // --- 创建原文部分 ---
                        //    const originalSentenceDiv = document.createElement('div');
                        //    originalSentenceDiv.className = 'original-sentence';
                        //    originalSentenceDiv.innerHTML = `<span class="translation-label">原文:</span> ${record.sentence || 'N/A'}`;
						//
                        //    // --- 创建翻译部分的行 ---
                        //    const translationsRow = document.createElement('div');
                        //    translationsRow.className = 'translations-row row g-3'; // 使用 Bootstrap 栅格，g-3 添加列间距
						//
                        //    // --- 左侧 AI 翻译列 ---
                        //    const aiCol = document.createElement('div');
                        //    aiCol.className = 'col-md-6';
                        //    const aiBox = document.createElement('div');
                        //    aiBox.className = 'translation-box ai-translation-box';
                        //    aiBox.innerHTML = `<span class="translation-label">AI翻译:</span> ${record.aiTranslation || 'N/A'}`;
                        //    aiCol.appendChild(aiBox);
						//
                        //    // --- 右侧 用户翻译列 ---
                        //    const userCol = document.createElement('div');
                        //    userCol.className = 'col-md-6';
                        //    const userBox = document.createElement('div');
                        //    userBox.className = 'translation-box user-translation-box';
                        //    userBox.innerHTML = `<span class="translation-label">你的翻译:</span> ${record.userTranslation || 'N/A'}`;
                        //    userCol.appendChild(userBox);
						//
                        //    // --- 组装卡片 ---
                        //    translationsRow.appendChild(aiCol);
                        //    translationsRow.appendChild(userCol);
                        //    
                        //    cardBody.appendChild(originalSentenceDiv);
                        //    cardBody.appendChild(translationsRow);
                        //    
                        //    card.appendChild(cardBody);
                        //    
                        //    // --- 将卡片添加到容器 ---
                        //    container.appendChild(card);
                        //});
						
						/////===== begin of card
						records.forEach((record, index) => {
							const addedDate = record.createdAt ? new Date(record.createdAt).toLocaleString() : 'N/A';
							// - 创建卡片元素 -
							const card = document.createElement('div');
							card.className = 'translation-record-card card';
						
							// - 创建卡片主体 -
							const cardBody = document.createElement('div');
							cardBody.className = 'card-body';
						
							// - 原句 -
							const originalSentenceDiv = document.createElement('div');
							originalSentenceDiv.className = 'original-sentence mb-3';
							originalSentenceDiv.innerHTML = `<span class="sentence-label">原句:</span> <strong>${record.sentence || 'N/A'}</strong>`;
						
							// - 翻译行 (AI 和 用户) -
							const translationsRow = document.createElement('div');
							translationsRow.className = 'row';
						
							// - 左侧 AI 翻译列 -
							const aiCol = document.createElement('div');
							aiCol.className = 'col-md-6';
							const aiBox = document.createElement('div');
							aiBox.className = 'translation-box ai-translation-box';
							aiBox.innerHTML = `<span class="translation-label">AI翻译:</span> ${record.aiTranslation || 'N/A'}`;
							aiCol.appendChild(aiBox);
						
							// - 右侧 用户翻译列 -
							const userCol = document.createElement('div');
							userCol.className = 'col-md-6';
							const userBox = document.createElement('div');
							userBox.className = 'translation-box user-translation-box';
							userBox.innerHTML = `<span class="translation-label">你的翻译:</span> ${record.userTranslation || 'N/A'}`;
							userCol.appendChild(userBox);
						
							// - 组装翻译行 -
							translationsRow.appendChild(aiCol);
							translationsRow.appendChild(userCol);
						
							// --- 关键修改点：在这里插入评分显示逻辑 ---
							// 1. 获取评分 (模拟或从 record 获取)
							//    注意：record.score 可能不存在或为 null，需要处理
							console.log(`[DEBUG] Processing record ${index}:`, record);
							const score = record.score; // 从后端获取的评分
							console.log(`[DEBUG] Extracted score for record ${index}:`, score);
							console.log(`[DEBUG] Processing record ${index}, ID: ${record._id}, Score:`, score); // <-- 添加调试日志
						
							// 2. 创建评分元素容器
							const scoreElement = document.createElement('div');
							scoreElement.className = 'score-display mt-2'; // 添加 margin-top 使其与上方内容有间距
							scoreElement.style.fontSize = '0.9rem'; // 可选：设置字体大小
							scoreElement.style.fontWeight = 'bold'; // 可选：加粗
						
							// 3. 根据评分值设置内容和样式
							if (score !== null && score !== undefined && !isNaN(score)) {
								console.log(`[DEBUG] Record ${index} has valid score: ${score}`); // <-- 打印
								// 如果评分存在且是有效数字
								
								let scoreText = '';
								let iconClass = '';
								if (score >= 8) {
									// 高分 (8-10)
									scoreText = `${score}/10`;
									iconClass = 'bi bi-star-fill text-warning'; // 实心金星
									scoreElement.style.color = '#28a745'; // Bootstrap 成功绿色
								} else if (score >= 5) {
									// 中等分 (5-7)
									scoreText = `${score}/10`;
									iconClass = 'bi bi-star-half text-warning'; // 半星金星
									scoreElement.style.color = '#ffc107'; // Bootstrap 警告黄色
								} else {
									// 低分 (0-4)
									scoreText = `${score}/10`;
									iconClass = 'bi bi-star text-warning'; // 空心金星
									scoreElement.style.color = '#dc3545'; // Bootstrap 危险红色
								}
								// 设置评分元素的 HTML 内容，包含图标和分数
								scoreElement.innerHTML = `<i class="${iconClass}"></i> AI翻译评分: <strong>${scoreText}</strong>`;
								console.log(`[DEBUG] Score is valid (${score}), setting innerHTML for record ${index}:`, scoreElement.innerHTML);
							} else {
								// 如果评分不存在或无效，显示占位符或不显示
								console.log(`[DEBUG] Record ${index} has invalid or missing score. Value:`, score); // <-- 添加调试日志
								// 这里我们显示一个灰色的占位符
								scoreElement.innerHTML = `<i class="bi bi-question-circle text-muted"></i> AI翻译评分: <span class="text-muted">待评分</span>`;
								scoreElement.style.color = '#6c757d'; // Bootstrap 次要灰色
								console.log(`[DEBUG] Score is invalid/null, setting placeholder for record ${index}:`, scoreElement.innerHTML);
							}
						
							// - 组装卡片主体 -
							console.log(`[DEBUG] 准备为记录 ID ${record._id} 添加评分元素:`, scoreElement);
							cardBody.appendChild(originalSentenceDiv);
							cardBody.appendChild(translationsRow);
							// --- 关键修改点：将评分元素添加到卡片主体 ---
							console.log(`[DEBUG] About to append scoreElement to cardBody for record ${index}:`, scoreElement);
							cardBody.appendChild(scoreElement);
							console.log(`[DEBUG] 评分元素已添加到 cardBody for 记录 ID ${record._id}`);
							console.log(`[DEBUG] scoreElement appended to cardBody for record ${index}`);
							
							// - 组装卡片 -
							card.appendChild(cardBody);
						
							// - 将卡片添加到容器 -
							container.appendChild(card);
						});
						/////===== end of card
                        this.showMessage('翻译记录加载成功！', 'success');
                    } else {
                        throw new Error(result.error || '加载失败');
                    }
                } catch (error) {
                    console.error('加载翻译记录失败:', error);
                    this.showMessage('加载翻译记录失败：' + error.message, 'danger');
                    document.getElementById('translation-records-container').innerHTML = `<div class="text-center text-danger">加载失败: ${error.message}</div>`;
                }
            }
            // --- 修改结束 ---
        }

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function () {
            window.translationHistoryManager = new TranslationHistoryManager();
        });
    </script>
</body>
</html>